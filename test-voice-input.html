<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³å£°å…¥åŠ›æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-input {
            width: 100%;
            height: 100px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .test-button {
            background-color: #6f42c1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .test-button:hover {
            background-color: #5a359a;
        }
        .test-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .voice-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        .voice-button:hover {
            background-color: #218838;
        }
        .voice-button.listening {
            background-color: #dc3545;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .loading {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .status {
            font-size: 13px;
            color: #666;
            margin-top: 10px;
        }
        .browser-support {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .supported {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .not-supported {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>éŸ³å£°å…¥åŠ›æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h1>
    
    <div id="browser-support" class="browser-support"></div>
    
    <div class="test-section">
        <h2>1. éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆ</h2>
        <p>ãƒã‚¤ã‚¯ã®ä½¿ç”¨è¨±å¯ã‚’æ±‚ã‚ã‚‰ã‚ŒãŸå ´åˆã¯ã€Œè¨±å¯ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</p>
        <div style="position: relative;">
            <textarea class="test-input" id="voiceTestInput" placeholder="éŸ³å£°èªè­˜çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
            <button id="voiceTestBtn" class="voice-button" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
        </div>
        <div id="voiceStatus" class="status" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>2. AIãƒ¢ãƒ‡ãƒ«ç”Ÿæˆãƒ†ã‚¹ãƒˆï¼ˆéŸ³å£°å…¥åŠ›ä»˜ãï¼‰</h2>
        <p>éŸ³å£°ã§æ§‹é€ ãƒ¢ãƒ‡ãƒ«ã®æŒ‡ç¤ºã‚’å…¥åŠ›ã—ã¦AIã§ç”Ÿæˆã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>
        <div style="position: relative;">
            <textarea class="test-input" id="aiTestInput" placeholder="ä¾‹: é«˜ã•3mã€ã‚¹ãƒ‘ãƒ³6mã®é–€å‹ãƒ©ãƒ¼ãƒ¡ãƒ³ã€‚æŸ±è„šã¯å›ºå®šã€‚"></textarea>
            <button id="aiVoiceBtn" class="voice-button" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
        </div>
        <div style="margin-top: 10px;">
            <button class="test-button" onclick="testAIGeneration()">AIã§ç”Ÿæˆãƒ†ã‚¹ãƒˆ</button>
        </div>
        <div id="aiVoiceStatus" class="status" style="display: none;"></div>
        <div id="aiResult" class="result" style="display: none;"></div>
    </div>

    <div class="test-section">
        <h2>3. éŸ³å£°èªè­˜ã®è©³ç´°ãƒ†ã‚¹ãƒˆ</h2>
        <p>éŸ³å£°èªè­˜ã®å‹•ä½œçŠ¶æ³ã‚’è©³ç´°ã«ç¢ºèªã—ã¾ã™ã€‚</p>
        <button class="test-button" onclick="testDetailedVoiceRecognition()">è©³ç´°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <div id="detailedResult" class="result" style="display: none;"></div>
    </div>

    <script>
        // ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆç¢ºèª
        function checkBrowserSupport() {
            const supportDiv = document.getElementById('browser-support');
            const hasSupport = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
            
            if (hasSupport) {
                supportDiv.className = 'browser-support supported';
                supportDiv.textContent = 'âœ… ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™';
            } else {
                supportDiv.className = 'browser-support not-supported';
                supportDiv.textContent = 'âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“';
            }
        }

        // éŸ³å£°èªè­˜æ©Ÿèƒ½ã®å®Ÿè£…
        function setupVoiceRecognition(inputElement, statusElement, buttonElement) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                buttonElement.style.display = 'none';
                return null;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'ja-JP';
            
            let isListening = false;
            
            buttonElement.addEventListener('click', () => {
                if (isListening) {
                    recognition.stop();
                    isListening = false;
                    buttonElement.textContent = 'ğŸ¤';
                    buttonElement.classList.remove('listening');
                    statusElement.textContent = '';
                    statusElement.style.display = 'none';
                } else {
                    try {
                        recognition.start();
                        isListening = true;
                        buttonElement.textContent = 'â¹ï¸';
                        buttonElement.classList.add('listening');
                        statusElement.textContent = 'ğŸ¤ éŸ³å£°ã‚’èªè­˜ä¸­...';
                        statusElement.style.display = 'block';
                    } catch (error) {
                        console.error('éŸ³å£°èªè­˜ã®é–‹å§‹ã«å¤±æ•—:', error);
                        statusElement.textContent = 'âŒ éŸ³å£°èªè­˜ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ';
                        statusElement.style.display = 'block';
                        setTimeout(() => {
                            statusElement.style.display = 'none';
                        }, 3000);
                    }
                }
            });
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                console.log('éŸ³å£°èªè­˜çµæœ:', transcript);
                
                const currentText = inputElement.value.trim();
                if (currentText) {
                    inputElement.value = currentText + '\n' + transcript;
                } else {
                    inputElement.value = transcript;
                }
                
                isListening = false;
                buttonElement.textContent = 'ğŸ¤';
                buttonElement.classList.remove('listening');
                statusElement.textContent = 'âœ… éŸ³å£°èªè­˜å®Œäº†';
                statusElement.style.display = 'block';
                
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
                
                inputElement.focus();
            };
            
            recognition.onerror = (event) => {
                console.error('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:', event.error);
                
                isListening = false;
                buttonElement.textContent = 'ğŸ¤';
                buttonElement.classList.remove('listening');
                
                let errorMessage = 'éŸ³å£°èªè­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                switch (event.error) {
                    case 'no-speech':
                        errorMessage = 'éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
                        break;
                    case 'audio-capture':
                        errorMessage = 'ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“';
                        break;
                    case 'not-allowed':
                        errorMessage = 'ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“';
                        break;
                    case 'network':
                        errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                        break;
                    default:
                        errorMessage = `éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${event.error}`;
                }
                
                statusElement.textContent = 'âŒ ' + errorMessage;
                statusElement.style.display = 'block';
                
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 5000);
            };
            
            recognition.onend = () => {
                isListening = false;
                buttonElement.textContent = 'ğŸ¤';
                buttonElement.classList.remove('listening');
                
                if (statusElement.textContent === 'ğŸ¤ éŸ³å£°ã‚’èªè­˜ä¸­...') {
                    statusElement.textContent = 'â¹ï¸ éŸ³å£°èªè­˜ãŒçµ‚äº†ã—ã¾ã—ãŸ';
                    statusElement.style.display = 'block';
                    setTimeout(() => {
                        statusElement.style.display = 'none';
                    }, 2000);
                }
            };
            
            return recognition;
        }

        // AIç”Ÿæˆãƒ†ã‚¹ãƒˆ
        async function testAIGeneration() {
            const input = document.getElementById('aiTestInput');
            const prompt = input.value.trim();
            
            if (!prompt) {
                showResult('aiResult', 'æ§‹é€ ãƒ¢ãƒ‡ãƒ«ã®æŒ‡ç¤ºã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            showResult('aiResult', 'ğŸ§  AIãŒãƒ¢ãƒ‡ãƒ«ã‚’ç”Ÿæˆä¸­ã§ã™...', 'loading');

            try {
                const response = await fetch('/api/generate-model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt
                    }),
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('aiResult', `âœ… AIç”Ÿæˆãƒ†ã‚¹ãƒˆæˆåŠŸï¼\nãƒ¬ã‚¹ãƒãƒ³ã‚¹: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    const errorData = await response.json();
                    showResult('aiResult', `âŒ AIç”Ÿæˆãƒ†ã‚¹ãƒˆå¤±æ•— (${response.status}):\n${errorData.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showResult('aiResult', `âŒ AIç”Ÿæˆãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${error.message}`, 'error');
            }
        }

        // è©³ç´°éŸ³å£°èªè­˜ãƒ†ã‚¹ãƒˆ
        function testDetailedVoiceRecognition() {
            const resultDiv = document.getElementById('detailedResult');
            let result = '=== éŸ³å£°èªè­˜è©³ç´°ãƒ†ã‚¹ãƒˆçµæœ ===\n\n';
            
            // ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆç¢ºèª
            const hasWebkitSupport = 'webkitSpeechRecognition' in window;
            const hasStandardSupport = 'SpeechRecognition' in window;
            
            result += `1. ãƒ–ãƒ©ã‚¦ã‚¶ã‚µãƒãƒ¼ãƒˆç¢ºèª:\n`;
            result += `   - webkitSpeechRecognition: ${hasWebkitSupport ? 'âœ…' : 'âŒ'}\n`;
            result += `   - SpeechRecognition: ${hasStandardSupport ? 'âœ…' : 'âŒ'}\n\n`;
            
            if (hasWebkitSupport || hasStandardSupport) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                
                result += `2. SpeechRecognition ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ: âœ…\n`;
                result += `3. è¨­å®šå¯èƒ½ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£:\n`;
                result += `   - continuous: ${typeof recognition.continuous}\n`;
                result += `   - interimResults: ${typeof recognition.interimResults}\n`;
                result += `   - lang: ${typeof recognition.lang}\n`;
                result += `   - maxAlternatives: ${typeof recognition.maxAlternatives}\n\n`;
                
                result += `4. ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ç¢ºèª:\n`;
                result += `   - onresult: ${typeof recognition.onresult}\n`;
                result += `   - onerror: ${typeof recognition.onerror}\n`;
                result += `   - onend: ${typeof recognition.onend}\n`;
                result += `   - onstart: ${typeof recognition.onstart}\n\n`;
                
                result += `5. ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™:\n`;
                if (navigator.permissions) {
                    navigator.permissions.query({name: 'microphone'}).then(permission => {
                        result += `   - ãƒã‚¤ã‚¯æ¨©é™: ${permission.state}\n`;
                        showResult('detailedResult', result, 'success');
                    }).catch(() => {
                        result += `   - ãƒã‚¤ã‚¯æ¨©é™: ç¢ºèªä¸å¯\n`;
                        showResult('detailedResult', result, 'success');
                    });
                } else {
                    result += `   - ãƒã‚¤ã‚¯æ¨©é™: ç¢ºèªä¸å¯ï¼ˆPermissions APIæœªå¯¾å¿œï¼‰\n`;
                    showResult('detailedResult', result, 'success');
                }
            } else {
                result += `2. SpeechRecognition ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ: âŒ\n`;
                result += `   ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚\n`;
                showResult('detailedResult', result, 'error');
            }
        }

        // çµæœè¡¨ç¤ºé–¢æ•°
        function showResult(elementId, message, type = 'success') {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            checkBrowserSupport();
            
            // éŸ³å£°èªè­˜æ©Ÿèƒ½ã®è¨­å®š
            const voiceTestInput = document.getElementById('voiceTestInput');
            const voiceTestBtn = document.getElementById('voiceTestBtn');
            const voiceStatus = document.getElementById('voiceStatus');
            
            const aiTestInput = document.getElementById('aiTestInput');
            const aiVoiceBtn = document.getElementById('aiVoiceBtn');
            const aiVoiceStatus = document.getElementById('aiVoiceStatus');
            
            setupVoiceRecognition(voiceTestInput, voiceStatus, voiceTestBtn);
            setupVoiceRecognition(aiTestInput, aiVoiceStatus, aiVoiceBtn);
        });
    </script>
</body>
</html>
